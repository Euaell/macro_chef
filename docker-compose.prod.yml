# Production Docker Compose for Mizan Platform
# This is a reference configuration for production deployment
# Adjust environment variables and network names to match your infrastructure

version: '3.8'

services:
  backend:
    image: euaell/mizan-backend:latest
    container_name: mizan-backend
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080

      # Database - adjust connection string for your PostgreSQL instance
      - ConnectionStrings__PostgreSQL=Host=postgresql-db;Port=5432;Database=mizan;Username=admin;Password=CHANGE_ME;Pooling=true;Minimum Pool Size=0;Maximum Pool Size=1024;Timeout=15;CommandTimeout=30;Ssl Mode=Prefer;Trust Server Certificate=true;

      # Redis - adjust connection string for your Redis instance
      - ConnectionStrings__Redis=redis:6379,password=CHANGE_ME,abortConnect=false,connectTimeout=5000,syncTimeout=1000

      # BFF Trusted Secret (must match frontend)
      - Bff__TrustedSecret=${BFF_TRUSTED_SECRET}
      - Bff__AllowedOrigins__0=http://frontend:3000
      - Bff__AllowedOrigins__1=https://mizan.euaell.me

      # OpenAI API (optional, for AI features)
      - OpenAI__ApiKey=${OPENAI_API_KEY:-}

      # CORS Settings
      - Cors__Origins__0=http://frontend:3000
      - Cors__Origins__1=https://mizan.euaell.me

    networks:
      - proxy-net
      - postgresql-db-n8n

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          memory: 512M

  frontend:
    image: euaell/mizan-frontend:latest
    container_name: mizan-frontend
    restart: unless-stopped
    environment:
      - NODE_ENV=production

      # Database URL for BetterAuth
      - DATABASE_URL=${DATABASE_URL}

      # Backend API URL (internal Docker network)
      - API_URL=${API_URL}
      - BACKEND_API_URL=http://backend:8080

      # BetterAuth Configuration
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}
      - BETTER_AUTH_AUDIENCE=${BETTER_AUTH_AUDIENCE}
      - BETTER_AUTH_ISSUER=${BETTER_AUTH_ISSUER}
      - BETTER_AUTH_TRUST_HOST=true

      # BFF Proxy Secret (must match backend)
      - BFF_TRUSTED_SECRET=${BFF_TRUSTED_SECRET}

      # Cloudinary (for image uploads)
      - CLOUDINARY_API_SECRET=${CLOUDINARY_API_SECRET}

      # Disable Telemetry
      - NEXT_TELEMETRY_DISABLED=1

      # Email (Nodemailer)
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - SMTP_FROM=${SMTP_FROM}

      # OAuth Credentials (optional)
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID:-}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET:-}
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET:-}

    depends_on:
      backend:
        condition: service_healthy

    networks:
      - proxy-net
      - postgresql-db-n8n

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          memory: 256M

networks:
  proxy-net:
    external: true
  postgresql-db-n8n:
    external: true

# Notes:
# 1. Adjust network names to match your infrastructure
# 2. Set all secrets and passwords in .env file
# 3. Backend health check now uses wget (requires Dockerfile.prod update)
# 4. Frontend health check uses wget (requires Dockerfile.prod update)
# 5. Resource limits prevent containers from consuming all host resources
