# Production Docker Compose for Mizan Platform
# This is a reference configuration for production deployment
# Adjust environment variables and network names to match your infrastructure

version: '3.8'

services:
  backend:
    image: euaell/mizan-backend:latest
    container_name: mizan-backend
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # Override specific environment variables that differ from .env defaults
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      # JWT/JWKS validation
      - BetterAuth__Issuer=${BetterAuth__Issuer}
      - BetterAuth__Audience=${BetterAuth__Audience}
      - BetterAuth__JwksUrl=${BetterAuth__JwksUrl}
      - Cors__Origins__0=${BETTER_AUTH_URL}

    networks:
      - proxy-net
      - postgresql-db-n8n

    healthcheck:
      test: ["CMD-SHELL", "cat < /dev/null > /dev/tcp/127.0.0.1/8080 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          memory: 512M

  frontend:
    image: euaell/mizan-frontend:latest
    container_name: mizan-frontend
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # Override specific environment variables that differ from .env defaults
      - NODE_ENV=production
      - API_URL=http://backend:8080
      - BETTER_AUTH_TRUST_HOST=true
      - NEXT_TELEMETRY_DISABLED=1
      # Database migrations - set to "true" to run migrations on startup
      # NOTE: Frontend and backend share the same database. Drizzle only manages
      # Better Auth tables (users, accounts, sessions, verification, jwks).
      # EF Core (backend) manages all business logic tables.
      - RUN_DB_MIGRATIONS=true

    depends_on:
      backend:
        condition: service_healthy

    networks:
      - proxy-net
      - postgresql-db-n8n

    healthcheck:
      test: ["CMD-SHELL", "cat < /dev/null > /dev/tcp/127.0.0.1/3000 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          memory: 256M

  mcp:
    image: euaell/mizan-mcp:latest
    container_name: mizan-mcp
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5001
      - ConnectionStrings__PostgreSQL=${ConnectionStrings__PostgreSQL}
    networks:
      - proxy-net
      - postgresql-db-n8n
    healthcheck:
      test: ["CMD-SHELL", "cat < /dev/null > /dev/tcp/127.0.0.1/5001 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          memory: 256M

networks:
  proxy-net:
    external: true
  postgresql-db-n8n:
    external: true

# Configuration Notes:
#
# Environment Variables:
# - Create a .env file in the same directory as this docker-compose.yml
# - All secrets, connection strings, and configuration are loaded from .env
# - Only production-specific overrides are defined inline (NODE_ENV, ASPNETCORE_ENVIRONMENT, etc.)
# - See .env.example for required variables
#
# Runtime vs Build-time Variables (Next.js):
# - NEXT_PUBLIC_* variables are BAKED into the JS bundle at build time
# - Server-side variables (without NEXT_PUBLIC_) are evaluated at RUNTIME
# - For Docker: server-side vars can be changed without rebuild via .env file
# - For Docker: NEXT_PUBLIC_* vars require rebuild to change (set in Dockerfile.prod)
#
# Infrastructure:
# 1. Adjust network names to match your infrastructure (proxy-net, postgresql-db-n8n)
# 2. Health checks use simple TCP socket tests (no external dependencies)
# 3. Resource limits prevent containers from consuming all host resources
