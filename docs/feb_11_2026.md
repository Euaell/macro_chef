# MacroChef Full Refactor & Feature Implementation Plan

## Context

The MacroChef codebase has a functioning backend (ASP.NET Core 10, Clean Architecture, CQRS) with most endpoints implemented, but the frontend (Next.js 16, React 19, Bun) has architectural inconsistencies, incomplete feature integrations, and code that needs cleanup. The user wants to:

- Remove BFF architecture in favor of direct JWT-based API calls
- Clean up CSS, unify design system around custom brand/accent colors
- Complete all frontend feature integrations with existing backend endpoints
- Fix logging, types, server actions organization, and proxy.ts

## Execution Phases

This plan is organized into 7 phases, each independently deployable. Phases 1-3 are foundation work (no new features). Phases 4-7 are feature implementations.

---

## Phase 1: API Client & BFF Removal

**Goal:** Single unified API client pattern, remove all BFF code.

### 1a. Create server-side apiClient
- **File:** `frontend/lib/api.ts` (new, replaces both `auth-client.ts` apiClient and `backend-api-client.ts`)
- Server-side function: reads JWT from BetterAuth session via cookies, calls `API_URL` directly
- Client-side function: uses `getApiToken()` to get JWT, calls `NEXT_PUBLIC_API_URL` directly
- Both share: error handling, PascalCase→camelCase conversion, retry logic, token refresh
- Export: `serverApiClient()` and `clientApiClient()` (or detect environment automatically)

### 1b. Migrate all callBackendApi usages
- `frontend/data/ingredient.ts` → use `serverApiClient`
- `frontend/data/recipe.ts` → use `serverApiClient`
- `frontend/data/meal.ts` → use `serverApiClient`
- `frontend/data/goal.ts` → use `serverApiClient`
- `frontend/data/suggestion.ts` → use `serverApiClient`
- `frontend/data/audit.ts` → use `serverApiClient`
- `frontend/actions/meal.ts` → use `serverApiClient`

### 1c. Migrate client-side apiClient usages
- Update imports in all 19 files that use `apiClient` from `auth-client.ts`
- Keep `auth-client.ts` for auth-only exports (signIn, signUp, signOut, useSession, etc.)
- Remove `apiClient`, `getApiToken`, `validateSession`, `convertKeysToCamelCase` from `auth-client.ts`

### 1d. Delete BFF code
- Delete `frontend/app/api/bff/[...path]/route.ts`
- Delete `frontend/lib/backend-api-client.ts`
- Remove BFF-related path normalization (lines 121-123 in auth-client.ts)

### 1e. Update next.config.ts
- Remove the "JWT-only" comment
- No rewrites needed (direct calls)

**Files modified:** `lib/api.ts` (new), `lib/auth-client.ts`, all `data/*.ts`, `actions/meal.ts`, `next.config.ts`
**Files deleted:** `app/api/bff/[...path]/route.ts`, `lib/backend-api-client.ts`

---

## Phase 2: CSS & Design System Cleanup

**Goal:** Single source of truth for styles, unified color scheme.

### 2a. Deduplicate globals.css
- Remove duplicate CSS blocks (lines 225-281 duplicate lines 48-104)
- Remove the duplicate body rule in `@layer base` (line 221, already on line 41)
- Remove duplicate `* { @apply border-border }` (conflicts with line 45)

### 2b. Resolve shadcn vs custom design system
- Keep custom `@theme` block with `--color-brand-*` and `--color-accent-*`
- Keep shadcn `@theme inline` for component compatibility BUT remap `--color-accent` to brand orange (not gray)
- Remap `--color-primary` to brand green
- Update `:root` variables to align with brand colors:
  - `--primary` → brand-600 green
  - `--accent` → accent-500 orange
  - `--destructive` → keep red

### 2c. Fix shadcn components to use brand colors
- `components/ui/button.tsx` → primary variant uses `bg-primary` which now maps to brand green
- `components/ui/badge.tsx` → align with brand palette
- `components/ui/alert.tsx` → align destructive with brand palette
- `components/ui/label.tsx` → keep minimal
- `components/ui/sonner.tsx` → will inherit correct colors via CSS variables

### 2d. Keep custom cn()/cva() in lib/utils.ts
- User explicitly wants tailwind-merge (not clsx/cva packages)
- Current implementation uses `twMerge` already -- this is correct
- The custom `cva` works for the project's needs
- No changes needed here

### 2e. Remove unused CSS utilities
- Audit: are `.glass`, `.text-gradient`, `.animate-in` used anywhere? Remove if not.
- Convert any remaining `bg-linear-to-` to `bg-gradient-to-` (Tailwind v4 syntax)

**Files modified:** `app/globals.css`, `components/ui/button.tsx`, `components/ui/badge.tsx`, `components/ui/alert.tsx`, `components/ui/sonner.tsx`

---

## Phase 3: Infrastructure Fixes

### 3a. Logging - Explore pino with Bun
- Install `pino` (basic pino works with Bun without transports)
- Create `lib/logger.ts` replacement using pino:
  - Same API: `logger.createModuleLogger(name)` returning `{ info, warn, error, debug }`
  - Server-side: use `pino()` directly (works with `bun --bun next dev`)
  - Client-side: fallback to console (pino is server-only)
  - Production: JSON output (pino default)
  - Development: pretty output via inline formatting (NOT pino-pretty transport, since transports need `bun-plugin-pino`)
- If pino fails with Bun at runtime, fall back to fixing the current logger (module name bug at line 79-82)

### 3b. Fix proxy.ts
- Implement proper auth protection in `frontend/proxy.ts`
- Match protected routes: `/profile`, `/meals`, `/recipes/add`, `/recipes/*/edit`, `/meal-plan`, `/goal`, `/suggestions`, `/trainer`, `/admin`
- Check for BetterAuth session cookie existence (not full validation -- proxy should be fast)
- Redirect to `/login?redirect=<path>` if no session cookie
- Use proper `config.matcher` to exclude public routes, static files, API routes

### 3c. Consolidate server actions
- Move `actions/meal.ts` functions (`addMeal`, `deleteMeal`) into `data/meal.ts`
- Move `actions/audit.ts` into `data/audit.ts`
- Delete `frontend/actions/` directory
- Update all imports

### 3d. Fix type definitions - single source of truth
- All types should come from `types/api.generated.ts`
- Remove manual interfaces from: `data/ingredient.ts`, `data/meal.ts`, `data/mealPlan.ts`, `data/goal.ts`, `data/suggestion.ts`
- Import `components["schemas"]["FoodDto"]` etc. from generated types
- Create thin type aliases in `types/` if needed for convenience

### 3e. Codegen analysis
- Keep `openapi-typescript` codegen (TypeScript types from OpenAPI = best practice)
- Remove dead scripts from git status: `scripts/drizzle-safety-check.sh`, `scripts/generate-zod-schemas.mjs` (already deleted)
- Don't add Zod codegen -- not needed since backend has FluentValidation and forms use simple validation

**Files modified:** `lib/logger.ts`, `proxy.ts`, `data/meal.ts`, `data/audit.ts`, all `data/*.ts` (type imports), `types/` aliases
**Files deleted:** `actions/meal.ts`, `actions/audit.ts`, `actions/` directory

---

## Phase 4: Complete Recipe Features

### 4a. Recipe CRUD
Backend endpoints available:
- `GET /api/recipes` (with filters: SearchTerm, FavoritesOnly, IncludePublic, Page, PageSize)
- `GET /api/recipes/{id}`
- `POST /api/recipes`
- `PUT /api/recipes/{id}`
- `DELETE /api/recipes/{id}`
- `POST /api/recipes/{id}/favorite`

Frontend work:
- `data/recipe.ts` -- add `createRecipe`, `updateRecipe`, `deleteRecipe`, `toggleFavorite` server actions
- `recipes/add/page.tsx` -- verify create form works end-to-end
- `recipes/[recipeId]/edit/page.tsx` -- verify edit form works
- `recipes/[recipeId]/page.tsx` -- add favorite button, delete option (via RecipeActions)
- `recipes/page.tsx` -- fix double-fetch for favorites (use a single query with counts), add proper filter/sort (currently stub buttons)
- Separate lazy-loaded card component for logged-in users (show favorite state per card)

### 4b. Recipe visibility
- Public recipes visible to everyone (no auth)
- User's own recipes filtered separately
- Favorite recipes as a tab/filter

**Files modified:** `data/recipe.ts`, `recipes/page.tsx`, `recipes/[recipeId]/page.tsx`, `recipes/add/page.tsx`, `recipes/[recipeId]/edit/page.tsx`, `components/Recipes/`

---

## Phase 5: Connect Existing Backend Features

### 5a. Meal Plans (backend fully implemented)
Backend: `GET /api/mealplans`, `GET /{id}`, `POST /`, `POST /{id}/recipes`, `DELETE /{id}`

- Replace stubs in `data/mealPlan.ts` with real API calls
- `meal-plan/page.tsx` -- SSR, list user's meal plans, show meals per plan
- `meal-plan/add/page.tsx` -- create meal plan form (name, date range), add recipes to plan
- `meal-plan/shopping-list/page.tsx` -- wire up to `GET /api/shoppinglists`

### 5b. Shopping Lists (backend fully implemented)
Backend: `GET /api/shoppinglists`, `GET /{id}`, `POST /`, `POST /{id}/items`, `PATCH /items/{itemId}/toggle`

- Create `data/shoppingList.ts` with server actions
- Wire `meal-plan/shopping-list/page.tsx` to real data
- Toggle items (checked/unchecked)

### 5c. Body Measurements (backend has GET + POST)
Backend: `GET /api/bodymeasurements`, `POST /api/bodymeasurements`

- Create `data/bodyMeasurement.ts`
- Create `app/(dashboard)/body-measurements/page.tsx` -- SSR list + form to add new measurement
- Show weight, body fat %, measurements over time
- Add link from profile page

### 5d. Workouts (backend has POST only - limited)
Backend: `POST /api/workouts` (log workout), `GET /api/exercises` (list), `POST /api/exercises` (create)

- Create `data/workout.ts` and `data/exercise.ts`
- Create `app/(dashboard)/workouts/page.tsx` -- log workout form
- Create `app/(dashboard)/exercises/page.tsx` -- browse/add exercises
- Note: Backend is limited (no GET workouts, no edit/delete) -- implement what's available, log as known gap

### 5e. Achievements & Streaks (backend has GET + streak endpoints)
Backend: `GET /api/achievements`, `GET /api/achievements/streak`, `POST /api/achievements/streak`

- Create `data/achievement.ts`
- Create `app/(dashboard)/achievements/page.tsx` -- show badges, streak counter
- Add streak widget to dashboard/profile

### 5f. Daily Nutrition - Fix N+1
Backend: `GET /api/nutrition/daily?date=YYYY-MM-DD`

- The meals page currently makes 7 API calls for 7-day history
- Create a single server action that fetches 7 days in one call (or add backend endpoint for weekly summary)
- If backend doesn't support date range, use `Promise.all` in a single server action (still 7 calls but server-side, not waterfall from client)

**New files:** `data/shoppingList.ts`, `data/bodyMeasurement.ts`, `data/workout.ts`, `data/exercise.ts`, `data/achievement.ts`
**New pages:** `body-measurements/page.tsx`, `workouts/page.tsx`, `exercises/page.tsx`, `achievements/page.tsx`
**Modified:** `data/mealPlan.ts`, `meal-plan/page.tsx`, `meal-plan/add/page.tsx`, `meal-plan/shopping-list/page.tsx`, `meals/page.tsx`

---

## Phase 6: Trainer Features Fix

### 6a. Fix trainers/page.tsx crash
- Line 29: `apiClient()` returns parsed JSON, not `Response`. Remove `.json()` call.
- Use new `clientApiClient` from `lib/api.ts`

### 6b. Trainer pages UX
- `trainers/page.tsx` -- find trainers, send request (fix the `alert()` calls → use toast)
- `trainers/my-trainer/page.tsx` -- view current trainer details, permissions
- `trainers/requests/page.tsx` -- view pending requests with status
- `trainer/page.tsx` -- trainer dashboard (for trainers)
- `trainer/clients/[id]/page.tsx` -- client details view

### 6c. Trainer API endpoints available
- `POST /api/trainers/request` -- send connection request
- `POST /api/trainers/respond` -- accept/reject
- `GET /api/trainers/clients` -- list trainer's clients
- `GET /api/trainers/requests` -- pending requests (trainer side)
- `GET /api/trainers/clients/{clientId}/nutrition` -- client nutrition data
- `GET /api/trainers/available` -- list available trainers
- `GET /api/trainers/my-trainer` -- get user's trainer
- `GET /api/trainers/my-requests` -- user's sent requests

All pages should use the new apiClient, proper error handling with toast, and proper loading states.

**Files modified:** All trainer pages and components

---

## Phase 7: Profile Section & Session Management

### 7a. Comprehensive profile page
Current profile page is functional but modals (Notifications, Privacy, Appearance) are non-functional stubs.
- Either remove stub modals or wire to real settings
- Add session management section
- Add body measurements link
- Add achievements/streaks display
- Add workout history link

### 7b. Session management
BetterAuth handles sessions. Available via `auth.api`:
- List sessions: `auth.api.listSessions()`
- Revoke session: `auth.api.revokeSession()`
- Current session info already available via `useSession()`

- Fix `profile/sessions/page.tsx` to use real BetterAuth API
- Show: device, IP, last active, created date
- Allow revoking individual sessions
- Highlight current session

### 7c. Profile settings
- `profile/settings/page.tsx` -- already functional (change password, delete account)
- Ensure it uses proper error handling and toasts

**Files modified:** `profile/page.tsx`, `profile/sessions/page.tsx`

---

## Verification Plan

After each phase:
1. `bun run build` -- verify no TypeScript errors
2. `bun run lint` -- verify no lint errors
3. Manual test critical flows:
   - Auth: login, register, logout
   - Recipes: list, create, edit, delete, favorite
   - Meals: log, view history, delete
   - Meal plans: create, add recipes, view
   - Profile: edit, sessions, settings
4. `docker-compose up -d` -- verify Docker deployment works
5. Backend tests: `docker-compose --profile test up test`

## Estimated Scope

| Phase | Files Changed | New Files | Complexity |
|-------|--------------|-----------|------------|
| 1. API Client | ~25 | 1 | Medium |
| 2. CSS Cleanup | ~8 | 0 | Low |
| 3. Infrastructure | ~15 | 0 | Medium |
| 4. Recipes | ~8 | 0 | Medium |
| 5. Backend Features | ~12 | 8+ | High |
| 6. Trainer Fix | ~8 | 0 | Medium |
| 7. Profile | ~3 | 0 | Low |

Total: ~80 files touched, ~9 new files, 7 phases.
