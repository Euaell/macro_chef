# Frontend Database Migrations

## Overview

The frontend uses **Drizzle ORM** with **Better Auth** to manage authentication tables:
- `users` - User accounts
- `accounts` - OAuth provider accounts  
- `sessions` - User sessions
- `verification` - Email verification tokens
- `jwks` - JWT signing keys

## Migration Order - CRITICAL

**⚠️ IMPORTANT**: Frontend migrations must run **FIRST**, before backend migrations.

### Why?

1. The backend has tables with foreign keys to `users`
2. Those foreign keys will fail if `users` table doesn't exist
3. Frontend creates `users` table via Better Auth
4. Backend creates business tables with FKs to `users`

### Correct Order:
```
1. Frontend (Drizzle) → Creates users, accounts, sessions, etc.
2. Backend (EF Core) → Creates foods, recipes, workouts with FKs to users
```

## How Migrations Work

The frontend container runs migrations automatically on startup if `RUN_DB_MIGRATIONS=true`:

1. Container starts
2. `start.sh` checks `RUN_DB_MIGRATIONS` environment variable
3. If true, runs `drizzle-kit migrate`
4. Creates/updates auth tables
5. Starts Next.js server

## Configuration

### Environment Variables

```bash
# Required for migrations
RUN_DB_MIGRATIONS=true

# Database connection (same as backend)
DATABASE_URL=postgres://admin:password@host:5432/mizan
```

### docker-compose.yml

```yaml
frontend:
  environment:
    - RUN_DB_MIGRATIONS=true
    - DATABASE_URL=${DATABASE_URL}
```

## Schema Definition

Auth tables are defined in `db/schema.ts`. Only these 5 tables are managed by Drizzle:

```typescript
// BetterAuth Core Tables
export const users = pgTable("users", { ... });
export const accounts = pgTable("accounts", { ... });
export const sessions = pgTable("sessions", { ... });
export const verification = pgTable("verification", { ... });
export const jwks = pgTable("jwks", { ... });
```

**Note**: All other tables (foods, recipes, workouts, etc.) are managed by the backend via EF Core.

## Migration Files

Located in `db/migrations/`:
- SQL files generated by `drizzle-kit generate`
- Applied by `drizzle-kit migrate`
- Should only contain auth tables (5 tables total)

## Generating New Migrations

**⚠️ WARNING**: Only run this if you need to modify auth table structure.

```bash
cd frontend
bunx drizzle-kit generate
```

This will scan `db/schema.ts` and generate SQL migration files.

## Troubleshooting

### "users table already exists"

This is expected if backend ran first. The frontend migration uses `CREATE TABLE IF NOT EXISTS`, so it will skip existing tables.

### Foreign key errors in backend

This means backend migrations ran before frontend. **Solution**:
1. Stop all containers
2. Wipe database (if empty): `DROP SCHEMA public CASCADE; CREATE SCHEMA public;`
3. Start frontend first (creates users table)
4. Start backend second (creates business tables with FKs)

### Missing tables

If auth tables don't exist:
1. Check `RUN_DB_MIGRATIONS=true` is set
2. Check database connection is correct
3. Check logs: `docker-compose logs frontend`

## Relationship with Backend

```
┌─────────────────┐         ┌──────────────────┐
│   Frontend      │         │     Backend      │
│   (Drizzle)     │         │   (EF Core)      │
│                 │         │                  │
│  ┌───────────┐  │         │  ┌────────────┐  │
│  │   users   │◀─┼────FK───┼──┤   foods    │  │
│  │ accounts  │  │         │  │  recipes   │  │
│  │ sessions  │  │         │  │  workouts  │  │
│  │   jwks    │  │         │  │    etc.    │  │
│  └───────────┘  │         │  └────────────┘  │
│                 │         │                  │
└─────────────────┘         └──────────────────┘
        │                            │
        └──────────┬─────────────────┘
                   │
            ┌──────▼──────┐
            │  PostgreSQL │
            │   Database  │
            └─────────────┘
```

**Key Points**:
- Frontend owns and creates `users` table
- Backend references `users` but doesn't create it
- Both share the same database
- Both use `SetIsTableExcludedFromMigrations` (backend) or `tablesFilter` (frontend) to avoid conflicts

## See Also

- `../backend/MIGRATIONS.md` - Backend migration guide
- `drizzle.config.ts` - Drizzle configuration
- `db/schema.ts` - Schema definitions
